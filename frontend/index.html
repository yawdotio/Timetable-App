<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Generator - Create Your Calendar</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Environment configuration - load before app.js -->
    <script src="env-config.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>üìÖ Timetable to Calendar</h1>
                    <p class="subtitle">Import your timetable into Google Calendar, Outlook, or Apple Calendar in minutes</p>
                </div>
                <button class="info-btn" onclick="openTipsModal()" title="Helpful Tips">‚ÑπÔ∏è</button>
            </div>
        </header>
        <!-- Quick Start Guide & Tips are now in modal popup -->

        <!-- Step 1: Choose a Timetable -->
        <section id="gallery-section" class="section">
            <h2>üìö Available Timetables</h2>
            <p class="section-description">Select a timetable below to get started</p>
            <div id="gallery-list" class="gallery-list"></div>
        </section>

        <!-- Step 2: Column Mapping -->
        <section id="mapping-section" class="section hidden">
            <h2>Step 2: Configure Your Timetable</h2>
            <p class="section-description">Tell us which column contains what information</p>
            <div id="sheet-selector" class="sheet-selector hidden"></div>
            
            <!-- Base Date Selector -->
            <div class="base-date-selector">
                <div class="info-icon">üìÖ</div>
                <div class="base-date-content">
                    <label for="base-date-input">
                        <strong>Start Week Date (Optional):</strong>
                    </label>
                    <input type="date" id="base-date-input" class="date-input">
                    <p class="base-date-hint">
                        If your timetable has day names (Monday, Tuesday, etc.), select a starting date. 
                        The system will automatically calculate the next occurrence of each weekday.<br>
                        <strong>Example:</strong> If you select Jan 10, 2026 (Friday), then Monday events ‚Üí Jan 13, Tuesday events ‚Üí Jan 14, etc.
                    </p>
                </div>
            </div>
            
            <div class="mapping-grid">
                <div class="mapping-row">
                    <label>Date Column:</label>
                    <select id="date-column" class="mapping-select">
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
                <div class="mapping-row">
                    <label>Time Column:</label>
                    <select id="time-column" class="mapping-select">
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
                <div class="mapping-row">
                    <label>Event Title Column: *</label>
                    <select id="title-column" class="mapping-select" required>
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
                <div class="mapping-row">
                    <label>Location Column:</label>
                    <select id="location-column" class="mapping-select">
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
                <div class="mapping-row">
                    <label>End Time Column:</label>
                    <select id="end-time-column" class="mapping-select">
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
                <div class="mapping-row">
                    <label>Description Column:</label>
                    <select id="description-column" class="mapping-select">
                        <option value="">-- Select Column --</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="resetUpload()">Start Over</button>
                <button class="btn btn-primary" onclick="applyMapping()">Apply Mapping</button>
            </div>
        </section>

        <!-- Step 3: Event Selection -->
        <section id="selection-section" class="section hidden">
            <h2>Step 3: Select Events</h2>
            <p class="section-description">Review and select which events to include in your calendar</p>
            
            <!-- Course Level Selector -->
            <div class="level-filter-section">
                <div class="level-filter">
                    <label><strong>Filter by Level:</strong></label>
                    <div class="level-buttons">
                        <button class="level-btn active" onclick="filterByLevel('all')" data-level="all">All Levels</button>
                        <button class="level-btn" onclick="filterByLevel(100)" data-level="100">Level 100</button>
                        <button class="level-btn" onclick="filterByLevel(200)" data-level="200">Level 200</button>
                        <button class="level-btn" onclick="filterByLevel(300)" data-level="300">Level 300</button>
                        <button class="level-btn" onclick="filterByLevel(400)" data-level="400">Level 400</button>
                        <button class="level-btn" onclick="filterByLevel(500)" data-level="500">Level 500</button>
                        <button class="level-btn" onclick="filterByLevel(600)" data-level="600">Level 600</button>
                        <button class="level-btn" onclick="filterByLevel(700)" data-level="700">Level 700</button>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="search-filter-section">
                <input type="text" id="course-search" class="course-search" placeholder="üîç Search courses by name, venue, or code..." onkeyup="filterAndSearchEvents()">
                <div class="search-results-info" id="search-results-info"></div>
            </div>
            
            <div class="event-controls">
                <button class="btn btn-small" onclick="selectAllEvents()">Select All</button>
                <button class="btn btn-small" onclick="deselectAllEvents()">Deselect All</button>
                <span class="event-count" id="event-count">0 events selected</span>
            </div>

            <!-- Recurring Settings Panel -->
            <div class="recurring-settings-panel">
                <div class="recurring-header">
                    <div class="info-icon">‚ÑπÔ∏è</div>
                    <div>
                        <p><strong>Apply Recurring Pattern to All Events:</strong></p>
                        <p class="recurring-desc">Select a repeat pattern to apply to all selected events</p>
                    </div>
                </div>
                <div class="recurring-radio-group">
                    <label class="radio-option">
                        <input type="radio" name="recurring-all" value="none" checked onchange="applyRecurringToAll('none')">
                        <span>No Repeat</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="recurring-all" value="weekly" onchange="applyRecurringToAll('weekly')">
                        <span>Weekly</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="recurring-all" value="daily" onchange="applyRecurringToAll('daily')">
                        <span>Daily (Mon-Fri)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="recurring-all" value="custom" onchange="applyRecurringToAll('custom')">
                        <span>Custom Day</span>
                    </label>
                </div>
                <div id="custom-day-selector" class="custom-day-selector hidden">
                    <select id="custom-recurring-day" class="recurring-select" onchange="applyRecurringToAll('custom')">
                        <option value="">-- Select Day --</option>
                        <option value="MONDAY">Every Monday</option>
                        <option value="TUESDAY">Every Tuesday</option>
                        <option value="WEDNESDAY">Every Wednesday</option>
                        <option value="THURSDAY">Every Thursday</option>
                        <option value="FRIDAY">Every Friday</option>
                        <option value="SATURDAY">Every Saturday</option>
                        <option value="SUNDAY">Every Sunday</option>
                    </select>
                </div>
            </div>


            <div class="table-container">
                <table id="events-table" class="events-table">
                    <thead id="table-header"></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBackToMapping()">Back to Mapping</button>
                <button class="btn btn-success" onclick="generateCalendar()">Generate Calendar</button>
            </div>
        </section>

        <!-- Step 4: Download -->
        <section id="download-section" class="section hidden">
            <h2>‚úÖ Calendar Generated!</h2>
            
            <div class="success-box">
                <div class="success-icon">üéâ</div>
                <p><strong id="event-total">0</strong> events added to your calendar</p>
            </div>

            <!-- Calendar Preview -->
            <div class="calendar-preview-section">
                <h3>üìÖ Preview Your Calendar</h3>
                <div class="calendar-preview" id="calendar-preview">
                    <div class="preview-loading">Loading calendar preview...</div>
                </div>
            </div>

            <div class="calendar-settings">
                <div class="setting-row">
                    <label>Calendar Name:</label>
                    <input type="text" id="calendar-name" value="" class="text-input" placeholder="My Timetable">
                </div>
                <div class="setting-row">
                    <label>Timezone:</label>
                    <select id="timezone" class="mapping-select">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">Eastern Time</option>
                        <option value="America/Chicago">Central Time</option>
                        <option value="America/Denver">Mountain Time</option>
                        <option value="America/Los_Angeles">Pacific Time</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                        <option value="Australia/Sydney">Sydney</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label for="reminder-minutes">Reminder Time (minutes before event):</label>
                    <div class="reminder-input-group">
                        <input type="number" id="reminder-minutes" value="45" min="0" max="1440" class="text-input" onchange="updateReminderPreview()">
                        <span class="reminder-preview" id="reminder-preview">45 minutes before</span>
                    </div>
                </div>
            </div>

            <div class="download-options">
                <div class="import-reminder">
                    <div class="reminder-icon">‚ö†Ô∏è</div>
                    <div class="reminder-content">
                        <h4>Before You Import</h4>
                        <p>Make sure you've created a new calendar in your calendar app first! This makes it easy to delete the entire calendar at the end of the semester.</p>
                        <details>
                            <summary>Need help? ‚Üí</summary>
                            <div class="reminder-details">
                                <p><strong>Google Calendar:</strong> Click "+" next to "Other calendars" ‚Üí "Create new calendar"</p>
                                <p><strong>Outlook:</strong> Click "+" next to calendar list ‚Üí "Create new calendar"</p>
                                <p><strong>Apple Calendar:</strong> File ‚Üí New Calendar</p>
                            </div>
                        </details>
                    </div>
                </div>

                <h3>Choose Your Option:</h3>
                <div class="option-cards">
                    <div class="option-card">
                        <div class="option-icon">üì•</div>
                        <h4>Download Calendar</h4>
                        <p>Download a static .ics file to import into your calendar</p>
                        <button class="btn btn-primary" onclick="downloadCalendar()">
                            Download Now
                        </button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="startOver()">Generate Another</button>
            </div>
        </section>

        <!-- Subscription Form -->
        <!-- Removed: Subscription functionality is no longer available -->

        <!-- Subscription Success -->
        <!-- Removed: Subscription functionality is no longer available -->

        <!-- Subscriptions List -->
        <!-- Removed: Subscription functionality is no longer available -->

        <!-- Guide & Tips Modal -->
        <div id="guide-modal" class="modal hidden">
            <div class="modal-overlay" onclick="closeGuideModal()"></div>
            <div class="modal-content guide-modal-content">
                <div class="modal-header">
                    <h2>üöÄ Quick Start Guide</h2>
                    <button class="modal-close" onclick="closeGuideModal()">‚úï</button>
                </div>
                <div class="modal-body guide-modal-body">
                    <p class="guide-intro">Follow these 3 simple steps to get your calendar ready:</p>
                    
                    <div class="steps-grid">
                        <div class="step-card">
                            <div class="step-number">1Ô∏è‚É£</div>
                            <h3>Create a New Calendar</h3>
                            <p>Before importing, create a new calendar in your calendar app. This makes it easy to delete it at the end of the semester.</p>
                            <details>
                                <summary>How to create a new calendar ‚Üí</summary>
                                <div class="guide-content">
                                    <p><strong>Google Calendar:</strong> Click "+" next to "Other calendars" ‚Üí "Create new calendar" ‚Üí Name it (e.g., "Spring 2026")</p>
                                    <p><strong>Outlook:</strong> Click "+" next to calendar list ‚Üí "Create new calendar" ‚Üí Select privacy level</p>
                                    <p><strong>Apple Calendar:</strong> File ‚Üí New Calendar ‚Üí Choose account and name</p>
                                </div>
                            </details>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2Ô∏è‚É£</div>
                            <h3>Select Your Timetable</h3>
                            <p>Browse the gallery below and pick the timetable that matches your schedule. You can filter by course level and search by name.</p>
                        </div>

                        <div class="step-card">
                            <div class="step-number">3Ô∏è‚É£</div>
                            <h3>Import to Your Calendar</h3>
                            <p>Select the events you want, generate the calendar file, and import it into your new calendar. Done!</p>
                            <details>
                                <summary>How to import the file ‚Üí</summary>
                                <div class="guide-content">
                                    <p><strong>Google Calendar:</strong> Settings ‚Üí Import & Export ‚Üí "Select file from your computer" ‚Üí Choose the .ics file</p>
                                    <p><strong>Outlook:</strong> File ‚Üí Open & Export ‚Üí "Import a file" ‚Üí Choose the .ics file</p>
                                    <p><strong>Apple Calendar:</strong> File ‚Üí Import ‚Üí Select the .ics file</p>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="tips-section-modal">
                        <h3>üí° Helpful Tips</h3>
                        <ul class="tips-list">
                            <li><strong>Select Only What You Need:</strong> You can uncheck courses or labs you don't want in your calendar</li>
                            <li><strong>Recurring Events:</strong> Set courses to repeat weekly or on specific days so they continue throughout the semester</li>
                            <li><strong>Easy Cleanup:</strong> Since your timetable is in its own calendar, you can delete the entire calendar at semester's end</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <footer>
        <p>Built with FastAPI backend ‚Ä¢ <a id="api-docs-link" href="#" target="_blank">API Docs</a></p>
    </footer>
    <script>
        // Dynamically set API Docs link based on API_BASE_URL
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.getElementById('api-docs-link');
            if (link && CONFIG && CONFIG.API_BASE_URL) {
                link.href = CONFIG.API_BASE_URL.replace('/api/v1', '') + '/api/v1/docs';
            }
        });
    </script>

    <script src="app.js"></script>
    <script src="admin.js"></script>
</body>
</html>
