name: Deploy Backend to Cloud Run

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE || 'timetable-generator-api' }}
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY || 'timetable-generator' }}
  GAR_LOCATION: ${{ vars.GAR_LOCATION || 'us-central1' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          token_format: access_token

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Build and deploy to Cloud Run
        id: deploy
        run: |
          IMAGE="${GAR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GAR_REPOSITORY}/timetable-generator-api:${GITHUB_SHA}"
          echo "Using image: ${IMAGE}"

          gcloud builds submit --tag "${IMAGE}" .

          gcloud run deploy "${CLOUD_RUN_SERVICE}" \
            --image "${IMAGE}" \
            --region "${GCP_REGION}" \
            --platform managed \
            --allow-unauthenticated

      - name: Output service URL
        run: gcloud run services describe "$CLOUD_RUN_SERVICE" --region "$GCP_REGION" --format='value(status.url)'
